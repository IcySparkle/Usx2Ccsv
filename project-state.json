{
  "project": {
    "name": "UsxToCsv",
    "description": "PowerShell script that converts USX, USFM, and SFM Bible manuscripts into a unified CSV format for publishing, analysis, and layout workflows.",
    "owner": "Yasutaka",
    "state_version": "0.6.0",
    "last_updated": "2025-12-10"
  },

  "script": {
    "filename": "UsxToCsv.ps1",
    "language": "PowerShell",

    "entry_parameters": {
      "InputPath": "string (input file or folder containing .usx / .usfm / .sfm)",
      "OutputFolder": "string (optional path for CSV output)"
    },

    "current_behavior": {

      "input_support": [
        "Single .usx file",
        "Single .usfm file",
        "Single .sfm file",
        "Folder containing any mix of .usx / .usfm / .sfm"
      ],

      "format_detection": "By file extension (.usx → XML parser; .usfm/.sfm → token parser)",

      "output_strategy": "One CSV per source file, named <basename>.csv, written to OutputFolder or next to input file.",

      "csv_columns": [
        "Book",
        "Chapter",
        "Verse",
        "TextPlain",
        "TextStyled",
        "Footnotes",
        "Crossrefs",
        "Subtitle"
      ],

      "verse_handling": {
        "model": "One CSV row per verse across ALL formats",
        "chapter_number_source": {
          "usx": "chapter/@number",
          "usfm": "\\c"
        },
        "verse_number_source": {
          "usx": "verse/@number (from sid milestone)",
          "usfm": "\\v"
        },
        "end_of_verse": {
          "usx": "verse element with eid attribute",
          "usfm": "appearance of next \\v"
        },
        "behavior": "Text merged across paragraphs until verse ends",
        "whitespace_normalization": "Collapse multiple spaces, trim edges"
      },

      "inline_styles": {
        "char_element": "char (USX)",
        "usfm_markers": ["\\bd", "\\it", "\\nd", "\\wj", "\\add", "\\bdit", "\\qt"],
        "mapping": {
          "wj": "wj",
          "add": "add",
          "nd": "nd",
          "bdit": "bdit",
          "it": "i",
          "bd": "b",
          "qt": "i",
          "default": "span"
        },
        "inline_behavior": {
          "usx": "Wrap TextStyled with <tag>...</tag> when encountering <char style=\"...\">",
          "usfm": "Translate \\tag and \\tag* into styled spans; remove unknown markers"
        },
        "text_plain": "All tags removed",
        "superscript_suppression": {
          "usx": "<char style=\"sup\">…</char> ignored",
          "usfm": "\\sup…\\sup* and \\+sup…\\+sup* ignored"
        }
      },

      "notes_handling": {
        "model": "FT-only extraction, identical across USX and USFM",
        "usx": {
          "rule": "If <note style=\"x…\"> → Crossref; otherwise → Footnote",
          "caller_ignored": true,
          "fr_ignored": true,
          "ft_extraction": "Extract first <char style=\"ft\">"
        },
        "usfm": {
          "footnote_marker": "\\f … \\f*",
          "crossref_marker": "\\x … \\x*",
          "ft_extraction": "Extract \\ft… (stop at next backslash)",
          "caller_ignored": true,
          "fr_ignored": true
        },
        "column_format": {
          "Footnotes": "List of FT items joined by ' | '",
          "Crossrefs": "List of FT items joined by ' | '"
        }
      },

      "subtitle_handling": {
        "source_elements": {
          "usx": "para styles s, s1, s2, s3, sp, ms, mr, mt, mt1, mt2",
          "usfm": "\\s, \\s1-3, \\sp, \\ms, \\mr, \\mt, \\mt1-2"
        },
        "logic": "Subtitle text persists until next subtitle; attached to every verse",
        "chapter_reset": "Currently NOT resetting subtitle at new chapter"
      },

      "sorting": {
        "book_sort": "String",
        "chapter_sort": "Numeric",
        "verse_sort": "String (supports 3, 3a, 3b etc.)"
      }
    },

    "helpers": {
      "Normalize-Whitespace": "Collapses whitespace",
      "Get-AttrValue": "Safe XML attribute accessor",
      "Get-StyledTagName": "Maps USX/USFM styles to GREP tags",
      "Find-FtNode": "USX recursive search for first char ft",
      "ExtractFTFromNote": "USX FT-only extraction",
      "ExtractFtFromUsfmNoteText": "USFM FT-only extraction",
      "ExtractNotesFromUsfmSegment": "USFM removal & extraction of \\f and \\x blocks",
      "Process-UsfmContentSegment": "Parses inline styling, notes, and plain text in USFM sections",
      "Process-Node": "Main recursive USX XML walker",
      "Add-CurrentVerse": "Adds a row to CSV (USX)",
      "Add-CurrentVerseUsfm": "Adds a row to CSV (USFM)"
    }
  },

  "conventions": {
    "encoding": "UTF-8 for reading & writing",
    "csv_delimiter": "Comma",
    "footnote_join_delimiter": " | ",
    "crossref_join_delimiter": " | ",
    "tag_brackets": "<tag>…</tag> for GREP styling"
  },

  "known_limitations": [
    "No table/list structure export",
    "Does not reverse CSV to source formats",
    "Does not export poetry-level indentation metadata",
    "Does not yet support multi-book USX within one file",
    "Does not detect pericope boundaries beyond subtitle markers"
  ],

  "next_steps_todo": [
    {
      "id": "poetry_support",
      "description": "Add a PoetryLevel or ParaStyle column for q, q1, q2, q3, q4.",
      "status": "pending"
    },
    {
      "id": "separate_notes_csv",
      "description": "Optionally generate Footnotes.csv and Crossrefs.csv with richer metadata.",
      "status": "pending"
    },
    {
      "id": "subtitle_index",
      "description": "Build a per-book subtitle index CSV: Book, Chapter, FirstVerse, Subtitle.",
      "status": "pending"
    },
    {
      "id": "configurable_style_mapping",
      "description": "Load inline-style mapping from external JSON.",
      "status": "pending"
    },
    {
      "id": "multi-book_usx_support",
      "description": "Detect/handle USX files containing multiple <book> elements.",
      "status": "pending"
    }
  ],

  "usage_examples": {
    "single_usx": ".\\UsxToCsv.ps1 -InputPath \"C:\\Bible\\JHN.usx\"",
    "single_usfm": ".\\UsxToCsv.ps1 -InputPath \"C:\\Bible\\MRK.usfm\"",
    "folder_all_formats": ".\\UsxToCsv.ps1 -InputPath \"C:\\Bible\\Sources\"",
    "folder_custom_output": ".\\UsxToCsv.ps1 -InputPath \"C:\\Bible\\Sources\" -OutputFolder \"C:\\Bible\\CSV\""
  }
}
